<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Horse Race Quiz ‚Äî 7 Players, 30 Rounds (fixed seats + live ranks)</title>
<style>
  :root{
    --bg:#0c1220; --card:#131a2e; --ink:#e9f0ff; --muted:#9aa4bf; --edge:#22315c;
    --ok:#33d17a; --bad:#ff6b6b; --acc:#6ac2ff; --gold:#ffd36a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--ink)}
  .app{max-width:1100px; margin:24px auto; padding:16px}
  h1{margin:0 0 12px; font-size:24px}
  .top{display:flex; gap:16px; flex-wrap:wrap; align-items:flex-start}

  .card{background:var(--card); border:1px solid var(--edge); border-radius:12px; padding:14px}
  .controls{flex:1 1 360px}
  .trackWrap{flex:3 1 640px}

  .row{display:flex; align-items:center; gap:10px; margin:8px 0}
  label{font-size:14px;color:var(--muted)}
  input[type="text"],input[type="number"]{background:#0f1527; color:var(--ink); border:1px solid var(--edge); border-radius:8px; padding:6px 8px}
  input[type="text"]{width:140px} input[type="number"]{width:80px}

  .pill{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#0f1527; border:1px solid var(--edge); color:var(--muted)}
  .btn{cursor:pointer; border:1px solid var(--edge); background:#0f1527; color:var(--ink); padding:8px 10px; border-radius:10px; font-weight:600}
  .btn[disabled]{opacity:.5; cursor:not-allowed}
  .btn.good{border-color:#245c43; background:#0c1a16}
  .btn.warn{border-color:#5c2424; background:#1a0c0c}
  .btn.accent{border-color:#274f7c; background:#0d1626}
  .btn.gold{border-color:#7c6a27; background:#1a1506; color:var(--gold)}

  .playersGrid{display:grid; grid-template-columns: 1fr auto auto; gap:8px 12px; align-items:center; margin-top:8px}
  .tiny{font-size:12px; color:var(--muted)}
  .warning{color:var(--bad); font-weight:600; display:none}

  .track{margin-top:10px; border:1px solid var(--edge); border-radius:12px; padding:10px; background:#0f1527; position:relative; overflow:hidden}
  .lane{display:grid; grid-template-columns: 160px repeat(var(--cols), 1fr); gap:4px; align-items:center; margin:6px 0}
  .lane .name{display:flex; align-items:center; gap:6px; font-weight:700}
  .cell{height:26px; border:1px dashed #233257; border-radius:6px; display:flex; align-items:center; justify-content:center; font-size:12px; color:#7987a8}
  .horse{height:26px; border:2px solid var(--acc); background:#0b162b; border-radius:6px; display:flex; align-items:center; justify-content:center; font-size:16px; transition:transform .12s ease}
  .finish{background:#13253f; border-color:#355c92}
  .lead{outline:2px solid var(--gold); box-shadow:0 0 0 2px rgba(255,211,106,.2) inset}
  .legend{display:flex; gap:12px; align-items:center; margin-top:8px}
  .legend .swatch{width:16px; height:16px; border:1px solid var(--edge); background:#0b162b; border-radius:4px}
  .legend .swatch.finish{background:#13253f}

  .perRound{margin-top:12px; border-top:1px dashed var(--edge); padding-top:12px}
  .perRound h3{margin:0 0 8px; font-size:16px}
  .perRound .grid{display:grid; grid-template-columns: 1fr 90px 90px; gap:8px 12px; align-items:center}
  .footerBtns{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap}

  .roundMeta{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .timer{display:flex; align-items:center; gap:8px}
  .clock{font-variant-numeric:tabular-nums; font-weight:800}
  .blink{animation:blink 1s steps(2,end) infinite}
  @keyframes blink{50%{opacity:.3}}

  canvas.confetti{position:absolute; inset:0; pointer-events:none; mix-blend-mode:screen; opacity:.9}
  .toast{position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#0d1626; border:1px solid #274f7c; padding:8px 12px; border-radius:10px; font-weight:700}

  /* responsive */
  @media (max-width:920px){
    .lane{grid-template-columns: 120px repeat(var(--cols), 1fr);}
    input[type="text"]{width:110px}
  }
</style>
</head>
<body>
<div class="app">
  <h1>üêé Horse Race Quiz</h1>

  <div class="top">
    <!-- Controls -->
    <div class="card controls">
      <div class="row roundMeta">
        <div><strong>Rounds:</strong> <span id="roundNow">1</span>/<span id="roundTotal">30</span></div>
        <div class="pill">Correct = +1</div>
        <div class="pill">Fastest correct = +1</div>
      </div>

      <div class="row timer">
        <label>Round timer (s)</label>
        <input id="secs" type="number" min="5" max="300" value="20" />
        <button class="btn accent" id="startTimer">Start (T)</button>
        <button class="btn" id="stopTimer">Stop</button>
        <div class="clock" id="clock">00:20</div>
      </div>

      <div class="row">
        <label>Total rounds</label>
        <input id="totalRounds" type="number" min="1" max="100" value="30">
        <button class="btn accent" id="applyRounds">Apply</button>
      </div>

      <div class="row"><label>Player names</label></div>
      <div class="playersGrid" id="nameGrid"></div>

      <div class="perRound">
        <h3>Round Input</h3>
        <div class="tiny">Tick everyone who was <strong>correct</strong>. Select <strong>fastest</strong> among them (or hit keys <strong>1‚Äì7</strong> for fastest, <strong>Shift+1‚Äì7</strong> toggle correct). <em>Space</em> = Apply.</div>
        <div class="grid" id="roundGrid"></div>
        <div class="warning" id="warn">Fastest must be one of the correct players (or leave fastest unselected if no one was correct).</div>
        <div class="footerBtns">
          <button class="btn good" id="applyRound">Apply Round (Space)</button>
          <button class="btn" id="undoRound" disabled>Undo (Backspace)</button>
          <button class="btn warn" id="resetRace">Reset Race (R)</button>
          <button class="btn gold" id="exportCsv">Export CSV</button>
        </div>
        <div class="tiny">URL presets: <code>?p1=Alice&p2=Ben&...&rounds=30&secs=15</code></div>
      </div>
    </div>

    <!-- Track -->
    <div class="card trackWrap">
      <div class="legend">
        <div class="swatch"></div> Horse position
        <div class="swatch finish"></div> Finish
        <span class="pill">Leader outlined in gold</span>
      </div>
      <div id="track" class="track">
        <canvas class="confetti" id="confetti"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast" style="display:none"></div>

<audio id="beep" preload="auto">
  <source src="data:audio/wav;base64,UklGRmYAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAchYAAAB///8AAP///wAA" type="audio/wav">
</audio>

<script>
(function(){
  // --- Config / State ---
  const NUM_PLAYERS = 7;
  const INIT_NAMES = ["Player 1","Player 2","Player 3","Player 4","Player 5","Player 6","Player 7"];
  const emoji = "üêé";
  const state = {
    totalRounds: 30,
    roundNow: 1,
    players: [],      // {name, pos}
    history: []       // per round: [{idx, delta}, ...]
  };

  // --- DOM refs ---
  const elTrack = document.getElementById('track');
  const elRoundNow = document.getElementById('roundNow');
  const elRoundTotal = document.getElementById('roundTotal');
  const elTotalRoundsInput = document.getElementById('totalRounds');
  const elNameGrid = document.getElementById('nameGrid');
  const elRoundGrid = document.getElementById('roundGrid');
  const elApplyRound = document.getElementById('applyRound');
  const elUndo = document.getElementById('undoRound');
  const elReset = document.getElementById('resetRace');
  const elWarn = document.getElementById('warn');
  const elExport = document.getElementById('exportCsv');
  const elSecs = document.getElementById('secs');
  const elStart = document.getElementById('startTimer');
  const elStop = document.getElementById('stopTimer');
  const elClock = document.getElementById('clock');
  const elConfetti = document.getElementById('confetti');
  const elToast = document.getElementById('toast');
  const elBeep = document.getElementById('beep');

  // --- Timer ---
  let timerInt=null, remaining=0;

  // --- Init ---
  function init(){
    // URL presets
    const url = new URL(location.href);
    for (let i=1;i<=NUM_PLAYERS;i++){
      const v = url.searchParams.get('p'+i);
      if (v) INIT_NAMES[i-1] = decodeURIComponent(v);
    }
    const r = url.searchParams.get('rounds');
    if (r) state.totalRounds = clamp(parseInt(r,10),1,100);
    const s = url.searchParams.get('secs');
    if (s) elSecs.value = clamp(parseInt(s,10),5,300);

    // Load from localStorage if present
    const saved = safeParse(localStorage.getItem('horseRaceV2'));
    if (saved && Array.isArray(saved.players) && saved.players.length===NUM_PLAYERS){
      Object.assign(state, saved);
    } else {
      state.players = Array.from({length: NUM_PLAYERS}, (_,i)=>({name: INIT_NAMES[i], pos:0}));
      state.totalRounds = state.totalRounds || 30;
      state.roundNow = 1;
      state.history = [];
    }

    // UI priming
    document.getElementById('totalRounds').value = state.totalRounds;
    elRoundTotal.textContent = state.totalRounds;
    elRoundNow.textContent = state.roundNow;

    buildNameEditor();
    buildRoundInputs();
    renderTrack();
    updateUndoBtn();
    resizeConfetti();
    window.addEventListener('resize', resizeConfetti);
    tickClock(false);
  }

  // --- UI builders ---
  function buildNameEditor(){
    elNameGrid.innerHTML = '';
    state.players.forEach((p, i)=>{
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.value = p.name;
      nameInput.addEventListener('input', e=>{
        p.name = e.target.value || `Player ${i+1}`;
        const labC = document.getElementById(`labC${i}`);
        const labF = document.getElementById(`labF${i}`);
        if(labC) labC.textContent = p.name;
        if(labF) labF.textContent = p.name;
        renderTrack();
        save();
      });
      const posPill = document.createElement('div');
      posPill.className = 'pill';
      posPill.id = `posPill${i}`;
      posPill.textContent = 'Moves: 0 ‚Ä¢ Rank: -';

      const rowName = document.createElement('div'); rowName.textContent = `Seat #${i+1}`; rowName.className = 'pill';
      elNameGrid.append(nameInput,posPill,rowName);
    });
  }

  function buildRoundInputs(){
    elRoundGrid.innerHTML = '';
    const h1 = mk('div','pill','Player'); const h2 = mk('div','pill','Correct'); const h3 = mk('div','pill','Fastest');
    elRoundGrid.append(h1,h2,h3);

    state.players.forEach((p,i)=>{
      const nameCell = mk('div',null); const correctCell = mk('div',null); const fastestCell = mk('div',null);

      const c = mk('input'); c.type='checkbox'; c.id=`c${i}`;
      const f = mk('input'); f.type='radio'; f.name='fastest'; f.id=`f${i}`;
      const labName = mk('label',null,p.name); labName.htmlFor = `c${i}`; labName.id = `labC${i}`;
      const labF = mk('label',null,p.name); labF.htmlFor = `f${i}`; labF.id = `labF${i}`;

      nameCell.appendChild(labName);
      correctCell.appendChild(c);
      fastestCell.appendChild(f);
      elRoundGrid.append(nameCell,correctCell,fastestCell);
    });

    // radio toggle off on second click
    elRoundGrid.addEventListener('click', (e)=>{
      if(e.target && e.target.type==='radio'){
        e.target.dataset.toggled = e.target.dataset.toggled==='1' ? '0' : '1';
        if (e.target.dataset.toggled==='0') e.target.checked=false;
        [...document.querySelectorAll('input[name="fastest"]')].forEach(r=>{ if(r!==e.target) r.dataset.toggled='0'; });
      }
    });
  }

  // --- Ranking (dense ranks with ties) ---
  function computeRanks(){
    const pos = state.players.map(p=>p.pos);
    const uniq = [...new Set(pos)].sort((a,b)=>b-a); // high->low
    const rankOfPos = new Map(uniq.map((p,i)=>[p, i+1]));
    const freq = new Map(); pos.forEach(p=>freq.set(p,(freq.get(p)||0)+1));
    return pos.map(p => ({ rank: rankOfPos.get(p), tied: (freq.get(p)>1) }));
  }

  // --- Rendering ---
  function renderTrack(){
    const cols = state.totalRounds;
    elTrack.style.setProperty('--cols', String(cols));
    // clear lanes but keep confetti canvas
    [...elTrack.querySelectorAll('.lane')].forEach(n=>n.remove());

    const ranks = computeRanks();

    const maxPos = Math.max(...state.players.map(p=>p.pos));
    const leaders = new Set(
      state.players.map((p,i)=> p.pos===maxPos ? i : null).filter(i=>i!==null)
    );

    // Fixed seat order: 0..6
    state.players.forEach((p,i)=>{
      const lane = mk('div','lane');

      const { rank, tied } = ranks[i];
      let badge;
      if (rank === 1) badge = tied ? 'T1' : 'ü•á';
      else if (rank === 2) badge = tied ? 'T2' : 'ü•à';
      else if (rank === 3) badge = tied ? 'T3' : 'ü•â';
      else badge = tied ? `T${rank}` : `#${rank}`;

      const nameBox = mk('div','name');
      nameBox.innerHTML = `<span class="pill">${badge}</span> <strong>${escapeHtml(p.name)}</strong>`;
      lane.appendChild(nameBox);

      for (let c=0;c<cols;c++){
        const isFinish = (c === cols-1);
        const at = (c === Math.min(p.pos, cols-1));
        const cls = at ? 'horse' + (leaders.has(i)?' lead':'') : 'cell' + (isFinish?' finish':'');
        const cell = mk('div', cls, at ? 'üêé' : (isFinish ? 'üèÅ' : '¬∑'));
        lane.appendChild(cell);
      }
      elTrack.insertBefore(lane, elConfetti);

      // sidebar pill shows moves + rank
      const pill = document.getElementById(`posPill${i}`);
      if (pill) pill.textContent = `Moves: ${p.pos} ‚Ä¢ Rank: ${rank}${tied?' (tie)':''}`;
    });

    // winner check
    const finishCol = state.totalRounds - 1;
    const anyFinished = state.players.some(p=> p.pos >= finishCol);
    if (anyFinished){ toast('Finish reached! üéâ'); confettiBurst(); }
  }

  // --- Helpers ---
  function mk(tag, cls, txt){ const el=document.createElement(tag); if(cls) el.className=cls; if(txt!=null) el.textContent=txt; return el; }
  function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function clamp(n,min,max){ return Math.min(max,Math.max(min,n)); }
  function safeParse(s){ try{return JSON.parse(s)}catch{ return null } }
  function save(){ localStorage.setItem('horseRaceV2', JSON.stringify(state)); }

  function getRoundSelections(){
    const correct = [];
    let fastest = null;
    for(let i=0;i<NUM_PLAYERS;i++){
      const c = document.getElementById(`c${i}`).checked;
      const f = document.getElementById(`f${i}`).checked;
      if (c) correct.push(i);
      if (f) fastest = i;
    }
    return {correct, fastest};
  }
  function clearRoundSelections(){
    for(let i=0;i<NUM_PLAYERS;i++){
      const c = document.getElementById(`c${i}`); const f = document.getElementById(`f${i}`);
      c.checked=false; f.checked=false; f.dataset.toggled='0';
    }
  }
  function updateUndoBtn(){ elUndo.disabled = state.history.length===0; }

  function applyDeltas(deltas){
    state.history.push(deltas);
    deltas.forEach(({idx, delta})=>{
      state.players[idx].pos += delta;
    });
    save();
  }

  // --- Actions ---
  document.getElementById('applyRounds').addEventListener('click', ()=>{
    let v = clamp(parseInt(elTotalRoundsInput.value,10)||30,1,100);
    state.totalRounds = v;
    elRoundTotal.textContent = v;
    renderTrack(); save();
  });

  elApplyRound.addEventListener('click', applyRound);
  function applyRound(){
    const {correct, fastest} = getRoundSelections();
    if (fastest!==null && !correct.includes(fastest)){ elWarn.style.display='block'; return; }
    elWarn.style.display='none';

    const deltas = [];
    correct.forEach(idx => deltas.push({idx, delta:+1}));
    if (fastest!==null){ deltas.push({idx: fastest, delta:+1}); }

    applyDeltas(deltas);

    if (state.roundNow < state.totalRounds) state.roundNow++;
    elRoundNow.textContent = state.roundNow;

    clearRoundSelections();
    renderTrack();
    updateUndoBtn();
  }

  elUndo.addEventListener('click', ()=>{
    const last = state.history.pop();
    if (!last) return;
    last.forEach(({idx, delta})=>{
      state.players[idx].pos = Math.max(0, state.players[idx].pos - delta);
    });
    if (state.roundNow > 1) state.roundNow--;
    elRoundNow.textContent = state.roundNow;
    renderTrack(); updateUndoBtn(); save();
  });

  elReset.addEventListener('click', ()=>{
    if (!confirm('Reset the entire race? This clears positions and history.')) return;
    state.players.forEach(p=>p.pos=0);
    state.history = [];
    state.roundNow = 1;
    document.querySelectorAll('#roundGrid input').forEach(i=>{ if(i.type==='radio'){ i.dataset.toggled='0'; i.checked=false } else if(i.type==='checkbox'){ i.checked=false } });
    elRoundNow.textContent = state.roundNow;
    renderTrack(); updateUndoBtn(); save();
  });

  elExport.addEventListener('click', ()=>{
    const headers = ['Round'].concat(state.players.map(p=>csvEscape(p.name))).join(',');
    const rows = [headers];
    const running = state.players.map(()=>0);
    state.history.forEach((roundDeltas, i)=>{
      roundDeltas.forEach(({idx, delta})=> running[idx]+=delta);
      const row = [String(i+1)].concat(running.map(x=>String(x))).join(',');
      rows.push(row);
    });
    const finalRow = ['Final'].concat(state.players.map(p=>String(p.pos))).join(',');
    rows.push(finalRow);

    const csv = rows.join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download='horse_race_results.csv'; a.click();
    URL.revokeObjectURL(url);
  });
  function csvEscape(s){ return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s; }

  // --- Keyboard shortcuts ---
  document.addEventListener('keydown', (e)=>{
    if (e.target.tagName === 'INPUT' && e.target.type==='text') return; // don't hijack name edits

    // Space = Apply round
    if (e.code === 'Space'){ e.preventDefault(); applyRound(); return; }
    // Backspace = Undo
    if (e.code === 'Backspace'){ e.preventDefault(); elUndo.click(); return; }
    // R = reset
    if (e.key.toLowerCase()==='r'){ e.preventDefault(); elReset.click(); return; }
    // T = timer toggle
    if (e.key.toLowerCase()==='t'){ e.preventDefault(); if(timerInt) stopTimer(); else startTimer(); return; }

    // 1..7 or Numpad1..7
    const num = keyToPlayerIndex(e);
    if (num!==null){
      e.preventDefault();
      if (e.shiftKey){
        // toggle correct only
        const c = document.getElementById(`c${num}`);
        c.checked = !c.checked;
      } else {
        // set fastest and ensure correct
        const f = document.getElementById(`f${num}`);
        [...document.querySelectorAll('input[name="fastest"]')].forEach(r=>{ r.checked=false; r.dataset.toggled='0'; });
        f.checked = true; f.dataset.toggled='1';
        const c = document.getElementById(`c${num}`); c.checked = true;
      }
    }
  });

  function keyToPlayerIndex(e){
    const map = { 'Digit1':0,'Digit2':1,'Digit3':2,'Digit4':3,'Digit5':4,'Digit6':5,'Digit7':6,
                  'Numpad1':0,'Numpad2':1,'Numpad3':2,'Numpad4':3,'Numpad5':4,'Numpad6':5,'Numpad7':6 };
    return (e.code in map) ? map[e.code] : null;
  }

  // --- Timer bits ---
  elStart.addEventListener('click', startTimer);
  elStop.addEventListener('click', stopTimer);

  function startTimer(){
    if (timerInt) return;
    remaining = clamp(parseInt(elSecs.value,10)||20,5,300);
    elSecs.value = remaining;
    tickClock(true);
    timerInt = setInterval(()=>tickClock(true),1000);
  }
  function stopTimer(){ if(timerInt){ clearInterval(timerInt); timerInt=null; elClock.classList.remove('blink'); } }
  function tickClock(countdown){
    if (countdown){
      remaining = Math.max(0, remaining - (timerInt?1:0));
      if (remaining===0){
        elClock.classList.add('blink');
        try{ elBeep.currentTime=0; elBeep.play(); }catch{}
        stopTimer();
      }
      elClock.textContent = fmt(remaining);
    } else {
      const v = clamp(parseInt(elSecs.value,10)||20,5,300);
      elClock.textContent = fmt(v);
    }
  }
  function fmt(s){ const m = Math.floor(s/60).toString().padStart(2,'0'); const r=(s%60).toString().padStart(2,'0'); return `${m}:${r}`; }

  // --- Confetti + toast ---
  let confettiCtx;
  function resizeConfetti(){
    elConfetti.width = elTrack.clientWidth;
    elConfetti.height = elTrack.clientHeight;
    confettiCtx = elConfetti.getContext('2d');
  }
  function confettiBurst(){
    const N=140, parts=[];
    for(let i=0;i<N;i++){
      parts.push({
        x: Math.random()*elConfetti.width,
        y: -10,
        vx: (Math.random()-0.5)*3,
        vy: Math.random()*2+2,
        size: Math.random()*3+2,
        life: Math.random()*60+40
      });
    }
    let f=0;
    function step(){
      confettiCtx.clearRect(0,0,elConfetti.width,elConfetti.height);
      parts.forEach(p=>{
        p.x+=p.vx; p.y+=p.vy; p.vy+=0.03; p.life--;
        confettiCtx.globalAlpha = Math.max(0,p.life/100);
        confettiCtx.fillRect(p.x,p.y,p.size,p.size);
      });
      f++; if (f<120) requestAnimationFrame(step);
      else confettiCtx.clearRect(0,0,elConfetti.width,elConfetti.height);
    }
    confettiCtx.fillStyle = '#9ad1ff';
    requestAnimationFrame(step);
  }
  let toastTo=null;
  function toast(msg){
    elToast.textContent = msg; elToast.style.display='block';
    clearTimeout(toastTo); toastTo = setTimeout(()=>{ elToast.style.display='none'; }, 2500);
  }

  // --- Save clock + rounds UI changes ---
  document.getElementById('totalRounds').addEventListener('change', save);
  elSecs.addEventListener('change', ()=>tickClock(false));

  // --- Boot ---
  init();
})();
</script>
</body>
</html>
