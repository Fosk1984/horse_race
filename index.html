<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Horse Race Quiz ‚Äî SVG Horses with Coloured Jerseys</title>
<style>
  :root{
    --bg:#0c1220; --card:#131a2e; --ink:#e9f0ff; --muted:#9aa4bf; --edge:#22315c;
    --ok:#33d17a; --bad:#ff6b6b; --acc:#6ac2ff; --gold:#ffd36a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--ink); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}

  .raceTop{height:50vh; min-height:360px; position:relative; border-bottom:1px solid var(--edge)}
  canvas#raceCanvas{position:absolute; inset:0; width:100%; height:100%}

  .hud{
    position:absolute; left:12px; top:10px; display:flex; gap:8px; flex-wrap:wrap;
    background:rgba(15,21,39,.5); border:1px solid var(--edge); backdrop-filter:blur(6px);
    padding:8px 10px; border-radius:10px; font-size:12px
  }
  .hud .pill{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#0f1527; border:1px solid var(--edge); color:var(--muted)}
  .hud .title{font-weight:800; color:var(--ink)}
  .hudRight{position:absolute; right:12px; top:10px; display:flex; gap:10px; align-items:center}
  .clock{font-variant-numeric:tabular-nums; font-weight:800}
  .btnTiny{cursor:pointer; border:1px solid var(--edge); background:#0f1527; color:var(--ink); padding:6px 8px; border-radius:8px; font-weight:700; font-size:12px}

  .bottom{max-width:1100px; margin:18px auto; padding:0 16px 24px}
  .card{background:var(--card); border:1px solid var(--edge); border-radius:12px; padding:14px}

  .row{display:flex; align-items:center; gap:10px; margin:8px 0}
  label{font-size:14px;color:var(--muted)}
  input[type="text"],input[type="number"]{background:#0f1527; color:var(--ink); border:1px solid var(--edge); border-radius:8px; padding:6px 8px}
  input[type="text"]{width:140px} input[type="number"]{width:80px}
  .btn{cursor:pointer; border:1px solid var(--edge); background:#0f1527; color:var(--ink); padding:8px 10px; border-radius:10px; font-weight:600}
  .btn.good{border-color:#245c43; background:#0c1a16}
  .btn.warn{border-color:#5c2424; background:#1a0c0c}
  .btn.accent{border-color:#274f7c; background:#0d1626}
  .btn.gold{border-color:#7c6a27; background:#1a1506; color:var(--gold)}

  .playersGrid{display:grid; grid-template-columns: 1fr auto auto; gap:8px 12px; align-items:center; margin-top:8px}
  .tiny{font-size:12px; color:var(--muted)}
  .warning{color:var(--bad); font-weight:600; display:none}

  .perRound{margin-top:12px; border-top:1px dashed var(--edge); padding-top:12px}
  .perRound h3{margin:0 0 8px; font-size:16px}
  .perRound .grid{display:grid; grid-template-columns: 1fr 90px 90px; gap:8px 12px; align-items:center}
  .footerBtns{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap}

  .toast{position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#0d1626; border:1px solid #274f7c; padding:8px 12px; border-radius:10px; font-weight:700}

  @media (max-width:920px){
    .perRound .grid{grid-template-columns: 1fr 70px 70px}
  }
</style>
</head>
<body>

<div class="raceTop">
  <canvas id="raceCanvas"></canvas>

  <div class="hud">
    <span class="title">üêé Horse Race</span>
    <span id="roundHud" class="pill">Round 1/30</span>
    <span class="pill">Correct = +1</span>
    <span class="pill">Fastest correct = +1</span>
  </div>
  <div class="hudRight">
    <label class="tiny">Round timer (s)</label>
    <input id="secsTop" type="number" min="5" max="300" value="20" />
    <button class="btnTiny" id="startTimerTop">Start (T)</button>
    <button class="btnTiny" id="stopTimerTop">Stop</button>
    <div class="clock" id="clockTop">00:20</div>
  </div>
</div>

<div class="bottom">
  <div class="card">
    <div class="row">
      <label>Total rounds</label>
      <input id="totalRounds" type="number" min="1" max="100" value="30">
      <button class="btn accent" id="applyRounds">Apply</button>
      <span class="tiny">Keys: <strong>1‚Äì7</strong> fastest (+correct), <strong>Shift+1‚Äì7</strong> toggle correct, <strong>Space</strong> Apply, <strong>Backspace</strong> Undo, <strong>R</strong> Reset, <strong>T</strong> Timer.</span>
    </div>

    <div class="row"><label>Player names</label></div>
    <div class="playersGrid" id="nameGrid"></div>

    <div class="perRound">
      <h3>Round Input</h3>
      <div class="tiny">Tick everyone who was <strong>correct</strong>. Select <strong>fastest</strong> among them. Then Apply.</div>
      <div class="grid" id="roundGrid"></div>
      <div class="warning" id="warn">Fastest must be one of the correct players (or leave fastest unselected if no one was correct).</div>
      <div class="footerBtns">
        <button class="btn good" id="applyRound">Apply Round (Space)</button>
        <button class="btn" id="undoRound" disabled>Undo (Backspace)</button>
        <button class="btn warn" id="resetRace">Reset Race (R)</button>
        <button class="btn gold" id="exportCsv">Export CSV</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast" style="display:none"></div>

<script>
(function(){
  // ------- Config & State -------
  const NUM_PLAYERS = 7;
  const INIT_NAMES = ["Player 1","Player 2","Player 3","Player 4","Player 5","Player 6","Player 7"];

  // Jersey/saddlecloth colours (edit freely)
  const SILKS = ["#e74c3c","#3498db","#2ecc71","#f1c40f","#9b59b6","#e67e22","#1abc9c"];

  const state = {
    totalRounds: 30,
    roundNow: 1,
    players: [],          // {name, pos, animX}
    history: []
  };

  // ------- DOM (bottom) -------
  const elTotalRounds = document.getElementById('totalRounds');
  const elApplyRounds = document.getElementById('applyRounds');
  const elNameGrid = document.getElementById('nameGrid');
  const elRoundGrid = document.getElementById('roundGrid');
  const elWarn = document.getElementById('warn');
  const elApplyRound = document.getElementById('applyRound');
  const elUndo = document.getElementById('undoRound');
  const elReset = document.getElementById('resetRace');
  const elExport = document.getElementById('exportCsv');
  const elRoundHud = document.getElementById('roundHud');

  // ------- Timer (top HUD) -------
  const elSecsTop = document.getElementById('secsTop');
  const elStartTop = document.getElementById('startTimerTop');
  const elStopTop  = document.getElementById('stopTimerTop');
  const elClockTop = document.getElementById('clockTop');
  let timerInt=null, remaining=0;

  // ------- Canvas -------
  const canvas = document.getElementById('raceCanvas');
  const ctx = canvas.getContext('2d');
  let W=0, H=0, t=0;
  let baseScroll = 140, scrollBoost = 0, trackOffset = 0;

  const leftPad = 100, rightPad = 80;
  const finishLineX = ()=> W - rightPad;
  const startLineX  = ()=> leftPad;

  // --- SVG horse frames (3-frame gallop), bigger, per-player colour + number ---
  const HORSE_W = 72, HORSE_H = 46;
  const horseFrames = Array.from({length:NUM_PLAYERS}, ()=>[]); // [player][frame] -> Image

  function svgDataUrl(frame, silk, number, body="#f7f7fb", stroke="#0b162b"){
    // Leg poses per frame
    const legPos = [
      [[10,36,18,44],[24,36,18,44],[36,36,46,44],[52,36,46,44]],
      [[10,36,16,44],[24,36,32,44],[36,36,32,44],[52,36,60,44]],
      [[10,36,18,44],[24,36,20,44],[36,36,48,44],[52,36,46,44]],
    ][frame%3];

    // Saddlecloth rect and silk cap coloured + jersey number on cloth
    const textFill = "#ffffff";
    const svg =
`<svg xmlns="http://www.w3.org/2000/svg" width="${HORSE_W}" height="${HORSE_H}" viewBox="0 0 72 46">
  <defs>
    <style>
      @font-face{font-family:ui;src:local("Segoe UI"),local("Roboto"),local("Arial")}
    </style>
  </defs>
  <g fill="none" stroke="${stroke}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <!-- body -->
    <path d="M12 26 C 26 16, 46 16, 58 26 C 50 32, 20 32, 12 26 Z" fill="${body}" />
    <!-- neck + head -->
    <path d="M44 24 L 58 18 L 66 21 L 61 24 L 52 26 Z" fill="${body}" />
    <circle cx="66" cy="21" r="1.6" fill="${stroke}"/>
    <!-- tail -->
    <path d="M10 26 Q 4 28, 6 34" />
    <!-- legs -->
    <path d="M${legPos[0][0]} ${legPos[0][1]} L ${legPos[0][2]} ${legPos[0][3]}" />
    <path d="M${legPos[1][0]} ${legPos[1][1]} L ${legPos[1][2]} ${legPos[1][3]}" />
    <path d="M${legPos[2][0]} ${legPos[2][1]} L ${legPos[2][2]} ${legPos[2][3]}" />
    <path d="M${legPos[3][0]} ${legPos[3][1]} L ${legPos[3][2]} ${legPos[3][3]}" />
  </g>

  <!-- SILKS: cap + saddlecloth -->
  <g>
    <!-- cap -->
    <path d="M56 17 q 5 -5, 9 0 q -5 2, -9 0 Z" fill="${silk}" stroke="${stroke}" stroke-width="1.3"/>
    <!-- saddlecloth -->
    <rect x="26" y="20" rx="2" ry="2" width="18" height="12" fill="${silk}" stroke="${stroke}" stroke-width="1.2"/>
    <text x="35" y="29" font-size="10" text-anchor="middle" fill="${textFill}" font-family="ui, system-ui, sans-serif">${number}</text>
  </g>
</svg>`;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
  }

  function preloadHorses(){
    for(let p=0; p<NUM_PLAYERS; p++){
      const silk = SILKS[p % SILKS.length];
      for(let f=0; f<3; f++){
        const img = new Image();
        img.src = svgDataUrl(f, silk, p+1);
        horseFrames[p][f] = img;
      }
    }
  }

  function resize(){
    const r = canvas.getBoundingClientRect();
    canvas.width = Math.floor(r.width * devicePixelRatio);
    canvas.height = Math.floor(r.height * devicePixelRatio);
    ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
    W = r.width; H = r.height;
  }
  window.addEventListener('resize', resize);

  // ------- Init -------
  function init(){
    const url = new URL(location.href);
    for (let i=1;i<=NUM_PLAYERS;i++){
      const v = url.searchParams.get('p'+i);
      if (v) INIT_NAMES[i-1] = decodeURIComponent(v);
    }

    state.players = Array.from({length:NUM_PLAYERS}, (_,i)=>({name: INIT_NAMES[i], pos:0, animX: startLineX()}));
    buildNameEditor();
    buildRoundInputs();
    elTotalRounds.value = state.totalRounds;
    elRoundHud.textContent = `Round ${state.roundNow}/${state.totalRounds}`;

    preloadHorses();
    resize();
    lastFrame = performance.now();
    requestAnimationFrame(loop);
  }

  // ------- UI builders -------
  function buildNameEditor(){
    elNameGrid.innerHTML = '';
    state.players.forEach((p, i)=>{
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.value = p.name;
      nameInput.addEventListener('input', e=>{
        p.name = e.target.value || `Player ${i+1}`;
      });
      const posPill = document.createElement('div');
      posPill.className = 'tiny'; posPill.id = `posPill${i}`; posPill.textContent = 'Moves: 0';

      const seat = document.createElement('div'); seat.className='tiny'; seat.textContent = `Seat #${i+1}`;
      elNameGrid.append(nameInput,posPill,seat);
    });
  }

  function buildRoundInputs(){
    elRoundGrid.innerHTML = '';
    const h1 = mk('div','tiny','Player'); const h2 = mk('div','tiny','Correct'); const h3 = mk('div','tiny','Fastest');
    elRoundGrid.append(h1,h2,h3);
    state.players.forEach((p,i)=>{
      const nameCell = mk('div',null); const correctCell = mk('div',null); const fastestCell = mk('div',null);
      const c = mk('input'); c.type='checkbox'; c.id=`c${i}`;
      const f = mk('input'); f.type='radio'; f.name='fastest'; f.id=`f${i}`;
      const labName = mk('label',null,p.name); labName.htmlFor = `c${i}`; labName.id = `labC${i}`;
      nameCell.appendChild(labName); correctCell.appendChild(c); fastestCell.appendChild(f);
      elRoundGrid.append(nameCell,correctCell,fastestCell);
    });

    elRoundGrid.addEventListener('click', (e)=>{
      if(e.target && e.target.type==='radio'){
        e.target.dataset.toggled = e.target.dataset.toggled==='1' ? '0' : '1';
        if (e.target.dataset.toggled==='0') e.target.checked=false;
        [...document.querySelectorAll('input[name="fastest"]')].forEach(r=>{ if(r!==e.target) r.dataset.toggled='0'; });
      }
    });
  }

  // ------- Actions -------
  elApplyRounds.addEventListener('click', ()=>{
    const v = clamp(parseInt(elTotalRounds.value,10)||30, 1, 100);
    state.totalRounds = v;
    elRoundHud.textContent = `Round ${state.roundNow}/${state.totalRounds}`;
  });

  elApplyRound.addEventListener('click', applyRound);
  function applyRound(){
    const {correct, fastest} = getRoundSelections();
    if (fastest!==null && !correct.includes(fastest)){ elWarn.style.display='block'; return; }
    elWarn.style.display='none';

    const deltas = [];
    correct.forEach(idx => deltas.push({idx, delta:+1}));
    if (fastest!==null){ deltas.push({idx: fastest, delta:+1}); }

    state.history.push(deltas);
    deltas.forEach(({idx, delta})=> state.players[idx].pos += delta);

    scrollBoost = 250;
    surgeFor(deltas.map(d=>d.idx));

    if (state.roundNow < state.totalRounds) state.roundNow++;
    elRoundHud.textContent = `Round ${state.roundNow}/${state.totalRounds}`;

    clearRoundSelections();
    updateSidebarPills();
    updateUndoBtn();
  }

  elUndo.addEventListener('click', ()=>{
    const last = state.history.pop();
    if (!last) return;
    last.forEach(({idx, delta})=>{
      state.players[idx].pos = Math.max(0, state.players[idx].pos - delta);
    });
    if (state.roundNow > 1) state.roundNow--;
    elRoundHud.textContent = `Round ${state.roundNow}/${state.totalRounds}`;
    updateSidebarPills(); updateUndoBtn();
  });

  elReset.addEventListener('click', ()=>{
    if(!confirm('Reset the race?')) return;
    state.players.forEach(p=>{ p.pos=0; p.animX=startLineX(); });
    state.history = [];
    state.roundNow = 1;
    elRoundHud.textContent = `Round ${state.roundNow}/${state.totalRounds}`;
    clearRoundSelections();
    updateSidebarPills(); updateUndoBtn();
  });

  elExport.addEventListener('click', ()=>{
    const headers = ['Round'].concat(state.players.map(p=>csvEscape(p.name))).join(',');
    const rows = [headers];
    const running = state.players.map(()=>0);
    state.history.forEach((roundDeltas, i)=>{
      roundDeltas.forEach(({idx, delta})=> running[idx]+=delta);
      const row = [String(i+1)].concat(running.map(x=>String(x))).join(',');
      rows.push(row);
    });
    const finalRow = ['Final'].concat(state.players.map(p=>String(p.pos))).join(',');
    rows.push(finalRow);
    const csv = rows.join('\n');
    downloadBlob(csv, 'horse_race_results.csv', 'text/csv');
  });

  function updateSidebarPills(){
    state.players.forEach((p,i)=>{
      const pill = document.getElementById(`posPill${i}`);
      if (pill) pill.textContent = `Moves: ${p.pos}`;
    });
  }
  function updateUndoBtn(){ elUndo.disabled = state.history.length===0; }

  // ------- Round selection helpers -------
  function getRoundSelections(){
    const correct = []; let fastest = null;
    for(let i=0;i<NUM_PLAYERS;i++){
      const c = document.getElementById(`c${i}`).checked;
      const f = document.getElementById(`f${i}`).checked;
      if (c) correct.push(i);
      if (f) fastest = i;
    }
    return {correct, fastest};
  }
  function clearRoundSelections(){
    for(let i=0;i<NUM_PLAYERS;i++){
      const c = document.getElementById(`c${i}`); const f = document.getElementById(`f${i}`);
      c.checked=false; f.checked=false; f.dataset.toggled='0';
    }
  }

  // ------- Timer -------
  elStartTop.addEventListener('click', startTimer);
  elStopTop.addEventListener('click', stopTimer);
  document.addEventListener('keydown', (e)=>{
    if (e.target.tagName === 'INPUT' && e.target.type==='text') return;
    if (e.code === 'Space'){ e.preventDefault(); applyRound(); return; }
    if (e.code === 'Backspace'){ e.preventDefault(); elUndo.click(); return; }
    if (e.key.toLowerCase()==='r'){ e.preventDefault(); elReset.click(); return; }
    if (e.key.toLowerCase()==='t'){ e.preventDefault(); if(timerInt) stopTimer(); else startTimer(); return; }

    const map = { 'Digit1':0,'Digit2':1,'Digit3':2,'Digit4':3,'Digit5':4,'Digit6':5,'Digit7':6,
                  'Numpad1':0,'Numpad2':1,'Numpad3':2,'Numpad4':3,'Numpad5':4,'Numpad6':5,'Numpad7':6 };
    const idx = map[e.code] ?? null;
    if (idx!==null){
      e.preventDefault();
      if (e.shiftKey){
        const c = document.getElementById(`c${idx}`); c.checked = !c.checked;
      } else {
        const f = document.getElementById(`f${idx}`);
        [...document.querySelectorAll('input[name="fastest"]')].forEach(r=>{ r.checked=false; r.dataset.toggled='0'; });
        f.checked = true; f.dataset.toggled='1';
        const c = document.getElementById(`c${idx}`); c.checked = true;
      }
    }
  });

  function startTimer(){
    if (timerInt) return;
    remaining = clamp(parseInt(elSecsTop.value,10)||20,5,300);
    elSecsTop.value = remaining;
    tickClock(true);
    timerInt = setInterval(()=>tickClock(true),1000);
  }
  function stopTimer(){ if(timerInt){ clearInterval(timerInt); timerInt=null; } }
  function tickClock(countdown){
    if (countdown){
      remaining = Math.max(0, remaining - 1);
      elClockTop.textContent = fmt(remaining);
      if (remaining===0) stopTimer();
    } else {
      const v = clamp(parseInt(elSecsTop.value,10)||20,5,300);
      elClockTop.textContent = fmt(v);
    }
  }
  function fmt(s){ const m = Math.floor(s/60).toString().padStart(2,'0'); const r=(s%60).toString().padStart(2,'0'); return `${m}:${r}`; }

  // ------- Canvas animation helpers -------
  const surge = new Set();
  function surgeFor(indices){
    indices.forEach(i=>surge.add(i));
    setTimeout(()=>{ indices.forEach(i=>surge.delete(i)); }, 600);
  }
  function approach(current, target, dt, speed){
    const diff = target - current;
    const step = Math.sign(diff) * Math.min(Math.abs(diff), speed*dt);
    return current + step;
  }

  // ------- Main loop & drawing -------
  let lastFrame = 0;
  function loop(now){
    const dt = Math.max(0.001, Math.min(0.05, (now - lastFrame)/1000));
    lastFrame = now; t += dt;

    const scrollPx = (baseScroll + scrollBoost) * dt;
    trackOffset = (trackOffset + scrollPx) % 2000;
    scrollBoost = Math.max(0, scrollBoost - 400*dt);

    const startX = startLineX(), finishX = finishLineX();
    const finishIdx = Math.max(1, state.totalRounds - 1);

    state.players.forEach((p,i)=>{
      const percent = clamp(p.pos / finishIdx, 0, 1);
      const target = startX + percent * (finishX - startX);
      const extra = surge.has(i) ? 520 : 320;
      p.animX = approach(p.animX, target, dt, extra);
    });

    draw(dt);
    requestAnimationFrame(loop);
  }

  function draw(dt){
    ctx.clearRect(0,0,W,H);
    drawSky();
    drawStands((trackOffset*0.18)%W);
    drawFence((trackOffset*0.45)%W);
    drawGrass((trackOffset)%W);
    drawFinish();
    drawHorses();
  }

  function drawSky(){
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,'#0f1836'); g.addColorStop(1,'#0b1329');
    ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
  }
  function drawStands(off){
    const y = 60;
    ctx.save(); ctx.globalAlpha = 0.35; ctx.fillStyle = '#0b1e35';
    for(let x=-W; x<W*2; x+=160){
      ctx.fillRect(Math.floor(x - off), y, 120, 30);
      for(let i=0;i<60;i++){
        const cx = Math.floor(x - off) + (i*2);
        const cy = y + 30 + Math.sin((i+ t*3)*0.3)*1.2;
        ctx.fillRect(cx, cy, 1, 3);
      }
    }
    ctx.restore();
  }
  function drawFence(off){
    const y = 120;
    ctx.strokeStyle = '#ffffff'; ctx.lineWidth = 3;
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
    ctx.fillStyle = '#e8e8e8';
    for(let x=-W; x<W*2; x+=60){
      const px = Math.floor(x - off*1.1);
      ctx.fillRect(px, y-14, 4, 14);
    }
  }
  function drawGrass(off){
    const top = 150, bottom = H-40;
    const laneH = (bottom - top) / NUM_PLAYERS;
    for(let l=0;l<NUM_PLAYERS;l++){
      const y0 = top + l*laneH;
      ctx.fillStyle = l%2 ? '#2c7a38' : '#2a6f33';
      ctx.fillRect(0, y0, W, laneH-4);
      ctx.strokeStyle = '#7ed38d'; ctx.lineWidth = 1.5;
      ctx.setLineDash([22,14]); ctx.lineDashOffset = -off*0.5;
      ctx.beginPath(); ctx.moveTo(0, y0 + (laneH*0.5)); ctx.lineTo(W, y0 + (laneH*0.5)); ctx.stroke();
    }
    ctx.setLineDash([]);
  }
  function drawFinish(){
    const x = finishLineX();
    const top = 150, bottom = H-40;
    for(let i=0;i<12;i++){
      ctx.fillStyle = i%2 ? '#ffffff' : '#cc2a2a';
      ctx.fillRect(x-3, top-18 + i*6, 6, 6);
    }
    for(let i=0;i<10;i++){
      ctx.fillStyle = i%2 ? '#ffffff' : '#111';
      ctx.fillRect(x-28 + i*5, top-28, 5, 20);
    }
    ctx.fillStyle = '#f0f6ff';
    ctx.font = '12px system-ui, sans-serif';
    ctx.fillText('FINISH', x-24, top-32);
  }
  function drawHorses(){
    const top = 150, bottom = H-40;
    const laneH = (bottom - top) / NUM_PLAYERS;
    const maxPos = Math.max(...state.players.map(p=>p.pos));
    const leaders = new Set(state.players.map((p,i)=> p.pos===maxPos ? i : null).filter(i=>i!==null));

    const frame = Math.floor(t*10) % 3;

    state.players.forEach((p,i)=>{
      const cy = top + i*laneH + laneH*0.5;
      const x = p.animX;

      if (leaders.has(i)){
        ctx.save();
        ctx.shadowColor = 'rgba(255,211,106,.7)'; ctx.shadowBlur = 14;
        ctx.fillStyle = 'rgba(255,211,106,.18)';
        ctx.beginPath(); ctx.arc(x, cy, 22, 0, Math.PI*2); ctx.fill();
        ctx.restore();
      }
      if (surge.has(i)){
        ctx.save(); ctx.strokeStyle = '#6ac2ff'; ctx.globalAlpha = 0.9;
        ctx.beginPath(); ctx.arc(x, cy, 20, 0, Math.PI*2); ctx.stroke(); ctx.restore();
      }

      const bob = Math.sin((t*6)+(i*0.7)) * 2.4;
      const tilt = Math.sin((t*2)+(i*0.9)) * 0.05;

      const img = horseFrames[i][frame];
      if (img && img.complete){
        ctx.save(); ctx.translate(x, cy + bob); ctx.rotate(tilt);
        ctx.drawImage(img, -HORSE_W/2, -HORSE_H/2, HORSE_W, HORSE_H);
        ctx.restore();
      }

      // name plate
      ctx.fillStyle = 'rgba(11,22,43,.85)'; ctx.strokeStyle = '#22315c'; ctx.lineWidth=1.5;
      const label = state.players[i].name; ctx.font = '13px system-ui, sans-serif';
      const w = ctx.measureText(label).width + 14;
      ctx.fillRect(x - w/2, cy + 28, w, 18); ctx.strokeRect(x - w/2, cy + 28, w, 18);
      ctx.fillStyle = '#cfe0ff'; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText(label, x, cy + 37);
    });
  }

  // ------- Utils -------
  function mk(tag, cls, txt){ const el=document.createElement(tag); if(cls) el.className=cls; if(txt!=null) el.textContent=txt; return el; }
  function clamp(n,min,max){ return Math.min(max,Math.max(min,n)); }
  function csvEscape(s){ return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s; }
  function downloadBlob(content, name, type){
    const blob = new Blob([content], {type}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = name; a.click();
    URL.revokeObjectURL(url);
  }

  // Boot
  init();
})();
</script>
</body>
</html>
