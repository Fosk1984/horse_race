<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Horse Race Quiz ‚Äî Field + Podium + Confetti</title>
<style>
  :root{
    --bg:#0c1220; --card:#131a2e; --ink:#e9f0ff; --muted:#9aa4bf; --edge:#22315c;
    --ok:#33d17a; --bad:#ff6b6b; --acc:#6ac2ff; --gold:#ffd36a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--ink); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}

  /* Race track now takes 3/4 of screen */
  .raceTop{
    height:75vh;
    min-height:480px;
    position:relative;
    border-bottom:1px solid var(--edge)
  }
  canvas#raceCanvas{position:absolute; inset:0; width:100%; height:100%}

  .hud{
    position:absolute; left:12px; top:10px; display:flex; gap:8px; flex-wrap:wrap;
    background:rgba(15,21,39,.5); border:1px solid var(--edge); backdrop-filter:blur(6px);
    padding:6px 8px; border-radius:8px; font-size:11px; z-index:5;
  }
  .hud .pill{padding:2px 6px; border-radius:999px; font-size:11px; background:#0f1527; border:1px solid var(--edge); color:var(--muted)}
  .hud .title{font-weight:800}
  .hudRight{position:absolute; right:12px; top:10px; display:flex; gap:8px; align-items:center; font-size:12px; z-index:5;}
  .clock{font-variant-numeric:tabular-nums; font-weight:800}
  .btnTiny{cursor:pointer; border:1px solid var(--edge); background:#0f1527; color:var(--ink); padding:4px 6px; border-radius:6px; font-weight:600; font-size:11px}

  /* Compact controls */
  .bottom{max-width:1100px; margin:12px auto; padding:0 12px 12px}
  .card{background:var(--card); border:1px solid var(--edge); border-radius:10px; padding:10px}
  .row{display:flex; align-items:center; gap:8px; margin:6px 0}
  label{font-size:13px;color:var(--muted)}
  input[type="text"],input[type="number"]{background:#0f1527; color:var(--ink); border:1px solid var(--edge); border-radius:6px; padding:4px 6px; font-size:13px}
  input[type="text"]{width:120px} input[type="number"]{width:70px}
  .btn{cursor:pointer; border:1px solid var(--edge); background:#0f1527; color:var(--ink); padding:6px 8px; border-radius:8px; font-weight:600; font-size:13px}
  .btn.good{border-color:#245c43; background:#0c1a16}
  .btn.warn{border-color:#5c2424; background:#1a0c0c}
  .btn.accent{border-color:#274f7c; background:#0d1626}
  .btn.gold{border-color:#7c6a27; background:#1a1506; color:var(--gold)}

  .playersGrid{display:grid; grid-template-columns: 1fr auto auto; gap:6px 10px; align-items:center; margin-top:6px}
  .tiny{font-size:11px; color:var(--muted)}
  .warning{color:var(--bad); font-weight:600; display:none; font-size:12px}

  .perRound{margin-top:8px; border-top:1px dashed var(--edge); padding-top:8px}
  .perRound h3{margin:0 0 6px; font-size:14px}
  .perRound .grid{display:grid; grid-template-columns: 1fr 70px 70px; gap:6px 10px; align-items:center}
  .footerBtns{display:flex; gap:6px; margin-top:8px; flex-wrap:wrap}

  /* Podium overlay */
  .overlay{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    background:rgba(9,13,25,.65); backdrop-filter: blur(6px); z-index:20;
  }
  .overlay.show{display:flex}
  .podium{
    position:relative; background:#0f1527; border:1px solid var(--edge);
    border-radius:14px; padding:16px 18px; width:min(680px, 92vw);
    box-shadow:0 10px 40px rgba(0,0,0,.35);
  }
  .podium h2{margin:0 0 8px; font-size:20px}
  .podium .stage{display:flex; gap:10px; align-items:flex-end; justify-content:center; margin-top:10px}
  .plinth{border:1px solid var(--edge); background:#0c1529; border-radius:10px 10px 6px 6px; width:30%; text-align:center; padding:8px 6px}
  .plinth .place{font-size:22px; font-weight:900}
  .plinth .name{margin-top:4px; font-size:14px; color:#cfe0ff}
  .p1{height:180px; background:linear-gradient(#ffe8a6,#ffd36a); color:#1a1400}
  .p2{height:150px; background:linear-gradient(#e8edf5,#cfd8e6); color:#0e1218}
  .p3{height:130px; background:linear-gradient(#ffd9b3,#ffb873); color:#241200}
  .podium .actions{display:flex; justify-content:center; gap:10px; margin-top:12px}
  .podium .actions .btn{font-size:13px}
  /* Bigger, black names on the podium */
.podium .plinth .name{
  color:#000 !important;
  font-size:20px;
  font-weight:900;
  letter-spacing:0.2px;
}


  /* Confetti canvas sits under podium card but above race */
  #confettiCanvas{
    position:fixed; inset:0; pointer-events:none; z-index:19; display:none;
  }
  #confettiCanvas.show{display:block;}
</style>
</head>
<body>

<!-- TOP: animated race -->
<div class="raceTop">
  <canvas id="raceCanvas"></canvas>

  <div class="hud">
    <span class="title">üêé Horse Race</span>
    <span id="roundHud" class="pill">Round 1/30</span>
    <span class="pill">Correct = +1</span>
    <span class="pill">Fastest correct = +1</span>
  </div>
  <div class="hudRight">
    <label class="tiny">Round timer (s)</label>
    <input id="secsTop" type="number" min="5" max="300" value="20" />
    <button class="btnTiny" id="startTimerTop">Start (T)</button>
    <button class="btnTiny" id="stopTimerTop">Stop</button>
    <div class="clock" id="clockTop">00:20</div>
  </div>
</div>

<!-- BOTTOM: controls/scoring -->
<div class="bottom">
  <div class="card">
    <div class="row">
      <label>Total rounds</label>
      <input id="totalRounds" type="number" min="1" max="100" value="30">
      <button class="btn accent" id="applyRounds">Apply</button>
      <span class="tiny">Keys: <strong>1‚Äì7</strong> fastest (+correct), <strong>Shift+1‚Äì7</strong> toggle correct, <strong>Space</strong> Apply, <strong>Backspace</strong> Undo, <strong>R</strong> Reset, <strong>T</strong> Timer.</span>
    </div>

    <div class="row"><label>Player names</label></div>
    <div class="playersGrid" id="nameGrid"></div>

    <div class="perRound">
      <h3>Round Input</h3>
      <div class="tiny">Tick everyone who was <strong>correct</strong>. Select <strong>fastest</strong> among them. Then Apply.</div>
      <div class="grid" id="roundGrid"></div>
      <div class="warning" id="warn">Fastest must be one of the correct players (or leave fastest unselected if no one was correct).</div>
      <div class="footerBtns">
        <button class="btn good" id="applyRound">Apply Round (Space)</button>
        <button class="btn" id="undoRound" disabled>Undo (Backspace)</button>
        <button class="btn warn" id="resetRace">Reset Race (R)</button>
        <button class="btn gold" id="exportCsv">Export CSV</button>
      </div>
    </div>
  </div>
</div>

<!-- Podium overlay + confetti -->
<canvas id="confettiCanvas"></canvas>
<div id="podiumOverlay" class="overlay" aria-hidden="true">
  <div class="podium" role="dialog" aria-modal="true" aria-labelledby="podiumTitle">
    <h2 id="podiumTitle">üèÜ Top 3 Finishers</h2>
    <div class="stage">
      <div class="plinth p2">
        <div class="place">ü•à 2nd</div>
        <div class="name" id="podium2">‚Äî</div>
      </div>
      <div class="plinth p1">
        <div class="place">ü•á 1st</div>
        <div class="name" id="podium1">‚Äî</div>
      </div>
      <div class="plinth p3">
        <div class="place">ü•â 3rd</div>
        <div class="name" id="podium3">‚Äî</div>
      </div>
    </div>
    <div class="actions">
      <button class="btn" id="closePodium">Close</button>
      <button class="btn gold" id="copyWinners">Copy winners</button>
    </div>
  </div>
</div>

<script>
<script>
(() => {
  // ====== SAFE RELOAD GUARD (avoid ‚ÄúCannot declare ‚Ä¶ twice‚Äù) ======
  if (window.RaceGame && typeof window.RaceGame.stop === 'function') {
    window.RaceGame.stop();
  }
  const RG = window.RaceGame = {};

  // ====== DOM HOOKS ======
  let canvas = document.getElementById('race');
  if (!canvas) {
    canvas = document.createElement('canvas');
    canvas.id = 'race';
    document.body.prepend(canvas);
  }
  const ctx = canvas.getContext('2d');

  // Podium container
  let podiumEl = document.getElementById('podium');
  if (!podiumEl) {
    podiumEl = document.createElement('div');
    podiumEl.id = 'podium';
    podiumEl.style.margin = '16px auto';
    podiumEl.style.maxWidth = '900px';
    document.body.appendChild(podiumEl);
  }

  // ====== SIZE / TRACK ======
  function resize() {
    canvas.width = Math.min(window.innerWidth, 1400);
    canvas.height = Math.max(260, Math.floor(window.innerHeight * 0.6)); // ~3/4 if your layout wraps it in a taller container
  }
  resize();
  window.addEventListener('resize', resize);

  const finishPadding = 60;
  const finishLineX = () => canvas.width - finishPadding;

  // ====== HORSES (single big lane ‚Äúfield‚Äù) ======
  const N = window.RACE_HORSES?.length || 6; // you can set window.RACE_HORSES = [{name,color},...] before this script
  const defaultNames = ['Comet','Blaze','Atlas','Nova','Ranger','Zephyr','Echo','Mamba'];
  const defaultColors = ['#c0392b','#2980b9','#27ae60','#8e44ad','#f39c12','#16a085','#d35400','#2c3e50'];

  const horses = Array.from({length: N}, (_, i) => {
    const meta = window.RACE_HORSES?.[i] || {};
    return {
      id: i,
      name: (meta.name || defaultNames[i % defaultNames.length]),
      color: (meta.color || defaultColors[i % defaultColors.length]),
      x: 20,
      y: 0,          // computed later in layout
      w: 52, h: 28,  // body size
      vx: 0,
      finished: false,
      place: null,
      surgeCooldown: 0
    };
  });

  function layoutHorses() {
    const top = 30;
    const bottom = canvas.height - 30;
    const band = bottom - top;
    horses.forEach((h, i) => {
      h.y = Math.round(top + (band * (i + 0.5)) / horses.length - h.h / 2);
    });
  }
  layoutHorses();

  // ====== RACE STATE ======
  let raf = null;
  let running = false;
  let tickNow = performance.now();
  let placeCounter = 0;
  let confettiFired = false;

  // ====== CONFETTI (canvas-confetti OR emoji fallback) ======
  function launchConfetti() {
    if (typeof window.confetti === 'function') {
      window.confetti({ particleCount: 220, spread: 75, startVelocity: 55, origin: { y: 0.3 } });
      window.confetti({ particleCount: 180, spread: 55, startVelocity: 45, origin: { x: 0.1, y: 0.4 } });
      window.confetti({ particleCount: 180, spread: 55, startVelocity: 45, origin: { x: 0.9, y: 0.4 } });
      return;
    }
    // Minimal fallback: sprinkle emojis for ~1.5s
    const drops = [];
    const emojis = ['üéâ','‚ú®','üéä','‚≠êÔ∏è','üí•'];
    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.left = 0;
    overlay.style.top = 0;
    overlay.style.right = 0;
    overlay.style.bottom = 0;
    overlay.style.pointerEvents = 'none';
    document.body.appendChild(overlay);
    for (let i = 0; i < 120; i++) {
      const span = document.createElement('span');
      span.textContent = emojis[i % emojis.length];
      span.style.position = 'absolute';
      span.style.left = (Math.random() * 100) + '%';
      span.style.top = (-10 - Math.random() * 30) + 'px';
      span.style.fontSize = (18 + Math.random() * 18) + 'px';
      span.style.filter = 'drop-shadow(0 2px 2px rgba(0,0,0,.3))';
      overlay.appendChild(span);
      drops.push({el: span, y: -50 - Math.random() * 50, vy: (1 + Math.random() * 3)});
    }
    const t0 = performance.now();
    function fall(t) {
      const dt = Math.min(32, t - (fall._t || t)); fall._t = t;
      drops.forEach(d => {
        d.y += d.vy * (dt * 0.25);
        d.el.style.transform = `translateY(${d.y}px)`;
      });
      if (t - t0 < 1500) requestAnimationFrame(fall);
      else overlay.remove();
    }
    requestAnimationFrame(fall);
  }

  // ====== PODIUM ======
  function renderPodium() {
    const finished = horses.filter(h => h.place !== null).sort((a,b) => a.place - b.place);
    if (!finished.length) { podiumEl.innerHTML = ''; return; }

    // Basic podium layout
    podiumEl.innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;align-items:end;">
        ${[2,1,3].map(rank => {
          const h = finished.find(x => x.place === rank);
          const height = rank === 1 ? 160 : (rank === 2 ? 120 : 100);
          return `
            <div style="text-align:center">
              <div style="background:#222; border-radius:14px 14px 0 0; height:${height}px; display:flex; align-items:center; justify-content:center;">
                <span style="font:800 34px/1.1 system-ui,Segoe UI,Arial; color:#fff;">${rank}</span>
              </div>
              <div style="padding:8px 4px;">
                <div style="font:700 22px/1.2 system-ui,Segoe UI,Arial; color:#000;">${h ? h.name : ''}</div>
                <div style="font:500 12px/1.2 system-ui,Segoe UI,Arial; color:#000; opacity:.7">${h ? 'Finished' : ''}</div>
              </div>
            </div>`;
        }).join('')}
      </div>
    `;
  }

  // ====== START / STOP ======
  RG.start = function startRace() {
    // reset state
    running = true; confettiFired = false; placeCounter = 0;
    horses.forEach(h => { h.x = 20; h.vx = 0; h.finished = false; h.place = null; h.surgeCooldown = 0; });
    renderPodium();
    tickNow = performance.now();
    loop(tickNow);
  };

  RG.stop = function stopRace() {
    running = false;
    if (raf) cancelAnimationFrame(raf);
    raf = null;
  };

  // ====== FINISH CHECK (first finisher triggers confetti ONCE) ======
  function checkFinish(h) {
    if (h.finished) return;
    if (h.x + h.w >= finishLineX()) {
      h.finished = true;
      h.x = Math.min(h.x, finishLineX() - h.w + 1);
      h.place = ++placeCounter;

      // Fire confetti exactly when the first horse finishes
      if (!confettiFired) {
        confettiFired = true;
        launchConfetti();
      }

      // Update podium as places come in
      renderPodium();
    }
  }

  // ====== LOOP ======
  function loop(t) {
    if (!running) return;
    const dt = Math.min(32, t - tickNow); tickNow = t;

    // speeds: base + noise + occasional surge, with cooldown
    horses.forEach(h => {
      const base = 0.08;                 // baseline px/ms
      const noise = (Math.random() - 0.5) * 0.06;
      let speed = base + noise;

      if (h.surgeCooldown <= 0 && Math.random() < 0.005) {
        h.vx = 0.4 + Math.random() * 0.35; // surge burst
        h.surgeCooldown = 1200 + Math.random() * 1200;
      } else if (h.vx > 0.02) {
        h.vx *= 0.96; // decay surge
      }

      h.surgeCooldown -= dt;
      speed += h.vx;

      // clamp speed
      if (speed < 0.02) speed = 0.02;
      if (speed > 0.85) speed = 0.85;

      // move only if not finished
      if (!h.finished) h.x += speed * dt;

      checkFinish(h);
    });

    draw();
    raf = requestAnimationFrame(loop);
  }

  // ====== DRAW ======
  function draw() {
    // background ‚Äúturf‚Äù
    ctx.fillStyle = '#2e8b57';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // single big lane border
    ctx.strokeStyle = 'rgba(255,255,255,.8)';
    ctx.lineWidth = 6;
    ctx.strokeRect(14, 14, canvas.width - 28, canvas.height - 28);

    // finish line (chequered)
    const fx = finishLineX();
    for (let y = 16, s = 12, toggle = 0; y < canvas.height - 16; y += s, toggle ^= 1) {
      ctx.fillStyle = toggle ? '#fff' : '#000';
      ctx.fillRect(fx, y, 10, s);
    }

    // horses (simple ‚Äúmore realistic-ish‚Äù blocks with head)
    horses.forEach(h => {
      // body
      ctx.fillStyle = h.color;
      ctx.fillRect(h.x, h.y, h.w, h.h);

      // head (front)
      ctx.fillStyle = '#3a2c24';
      ctx.fillRect(h.x + h.w - 10, h.y + 6, 12, 14);

      // name behind horses (black, bigger as requested)
      ctx.font = '700 18px system-ui, Segoe UI, Arial';
      ctx.fillStyle = 'rgba(0,0,0,0.85)';
      ctx.textBaseline = 'middle';
      ctx.fillText(h.name, Math.max(6, h.x - 6 - ctx.measureText(h.name).width), h.y + h.h / 2);
    });
  }

  // ====== PUBLIC HELPERS ======
  RG.setHorses = function(list) {
    // list: [{name,color}, ...]
    if (Array.isArray(list) && list.length) {
      for (let i = 0; i < horses.length && i < list.length; i++) {
        horses[i].name = list[i].name ?? horses[i].name;
        horses[i].color = list[i].color ?? horses[i].color;
      }
      renderPodium();
    }
  };

  RG.restart = function() { RG.stop(); RG.start(); };

  // Auto-start unless you control it elsewhere
  RG.start();

})();
</script>

</script>
</body>
</html>
