<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Horse Race Quiz ‚Äî HOST</title>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
  :root{
    --bg:#0c1220; --card:#131a2e; --ink:#e9f0ff; --muted:#9aa4bf; --edge:#22315c;
    --ok:#33d17a; --bad:#ff6b6b; --acc:#6ac2ff; --gold:#ffd36a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--ink); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}

  .raceTop{height:75vh; min-height:480px; position:relative; border-bottom:1px solid var(--edge)}
  canvas#raceCanvas{position:absolute; inset:0; width:100%; height:100%}

  .hud{
    position:absolute; left:12px; top:10px; display:flex; gap:8px; flex-wrap:wrap;
    background:rgba(15,21,39,.5); border:1px solid var(--edge); backdrop-filter:blur(6px);
    padding:6px 8px; border-radius:8px; font-size:11px; z-index:5;
  }
  .hud .pill{padding:2px 6px; border-radius:999px; font-size:11px; background:#0f1527; border:1px solid var(--edge); color:var(--muted)}
  .hud .title{font-weight:800}
  .hudRight{position:absolute; right:12px; top:10px; display:flex; gap:8px; align-items:center; font-size:12px; z-index:5;}
  .clock{font-variant-numeric:tabular-nums; font-weight:800}
  .btnTiny{cursor:pointer; border:1px solid var(--edge); background:#0f1527; color:var(--ink); padding:4px 6px; border-radius:6px; font-weight:600; font-size:11px}

  .bottom{max-width:1100px; margin:12px auto; padding:0 12px 12px}
  .card{background:var(--card); border:1px solid var(--edge); border-radius:10px; padding:10px}
  .row{display:flex; align-items:center; gap:8px; margin:6px 0}
  label{font-size:13px;color:var(--muted)}
  input[type="text"],input[type="number"]{background:#0f1527; color:var(--ink); border:1px solid var(--edge); border-radius:6px; padding:4px 6px; font-size:13px}
  input[type="text"]{width:120px} input[type="number"]{width:70px}
  .btn{cursor:pointer; border:1px solid var(--edge); background:#0f1527; color:var(--ink); padding:6px 8px; border-radius:8px; font-weight:600; font-size:13px}
  .btn.accent{border-color:#274f7c; background:#0d1626}
  .btn.gold{border-color:#7c6a27; background:#1a1506; color:var(--gold)}
  .playersGrid{display:grid; grid-template-columns: 1fr auto auto; gap:6px 10px; align-items:center; margin-top:6px}
  .tiny{font-size:11px; color:var(--muted)}

  .overlay{position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    background:rgba(9,13,25,.65); backdrop-filter: blur(6px); z-index:20;}
  .overlay.show{display:flex}
  .podium{position:relative; background:#0f1527; border:1px solid var(--edge); border-radius:14px; padding:16px 18px; width:min(680px, 92vw); box-shadow:0 10px 40px rgba(0,0,0,.35);}
  .podium h2{margin:0 0 8px; font-size:20px}
  .podium .stage{display:flex; gap:10px; align-items:flex-end; justify-content:center; margin-top:10px}
  .plinth{border:1px solid var(--edge); background:#0c1529; border-radius:10px 10px 6px 6px; width:30%; text-align:center; padding:8px 6px}
  .plinth .place{font-size:22px; font-weight:900}
  .plinth .name{margin-top:4px; font-size:20px; font-weight:900; color:#000 !important}
  .p1{height:180px; background:linear-gradient(#ffe8a6,#ffd36a); color:#1a1400}
  .p2{height:150px; background:linear-gradient(#e8edf5,#cfd8e6); color:#0e1218}
  .p3{height:130px; background:linear-gradient(#ffd9b3,#ffb873); color:#241200}

  #confettiCanvas{position:fixed; inset:0; pointer-events:none; z-index:19; display:none;}
  #confettiCanvas.show{display:block;}
</style>
</head>
<body>

<!-- Race -->
<div class="raceTop">
  <canvas id="raceCanvas"></canvas>

  <div class="hud">
    <span class="title">üêé Horse Race</span>
    <span id="roundHud" class="pill">Round 1/30</span>
    <span class="pill">Correct = +1</span>
    <span class="pill">Fastest correct = +1</span>
  </div>
  <div class="hudRight">
    <label class="tiny">Round timer (s)</label>
    <input id="secsTop" type="number" min="5" max="300" value="20" />
    <button class="btnTiny" id="startTimerTop">Start</button>
    <button class="btnTiny" id="stopTimerTop">Stop</button>
    <div class="clock" id="clockTop">00:20</div>
  </div>
</div>

<!-- Host controls -->
<div class="bottom">
  <div class="card" id="autoBar">
    <div class="row" style="flex-wrap:wrap; gap:10px">
      <label><strong>Mode</strong></label>
      <select id="modeSelect">
        <option value="auto" selected>Auto (Voting)</option>
        <option value="manual">Manual (tick + fastest)</option>
      </select>

      <label>Room code</label>
      <input id="roomCode" type="text" placeholder="e.g. 2468" value="2468">

      <button class="btn accent" id="createOrJoinRoom">Create/Join Room</button>
      <a class="btn" id="openPlayerLink" target="_blank" rel="noopener">Open Player Page</a>

      <span class="tiny">Status: <span id="autoStatus">Idle</span></span>
    </div>

    <div id="questionPane" class="row" style="display:flex; flex-wrap:wrap; gap:10px">
      <div><strong id="qIndex">Q 1</strong> ‚Äî <span id="qStem">‚Äî</span></div>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <span id="opt0" class="pill">A</span>
        <span id="opt1" class="pill">B</span>
        <span id="opt2" class="pill">C</span>
        <span id="opt3" class="pill">D</span>
      </div>
      <div style="display:flex; gap:8px; align-items:center">
        <span class="tiny">Time left:</span>
        <span class="pill" id="voteClock">‚Äî</span>
        <button class="btnTiny" id="forceLock">Force Lock</button>
        <button class="btnTiny" id="skipQ">Skip</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row"><label>Player names</label></div>
    <div class="playersGrid" id="nameGrid"></div>
  </div>
</div>

<!-- Podium + confetti -->
<canvas id="confettiCanvas"></canvas>
<div id="podiumOverlay" class="overlay" aria-hidden="true">
  <div class="podium" role="dialog" aria-modal="true" aria-labelledby="podiumTitle">
    <h2 id="podiumTitle">üèÜ Top 3 Finishers</h2>
    <div class="stage">
      <div class="plinth p2"><div class="place">ü•à 2nd</div><div class="name" id="podium2">‚Äî</div></div>
      <div class="plinth p1"><div class="place">ü•á 1st</div><div class="name" id="podium1">‚Äî</div></div>
      <div class="plinth p3"><div class="place">ü•â 3rd</div><div class="name" id="podium3">‚Äî</div></div>
    </div>
    <div class="actions" style="display:flex; justify-content:center; gap:10px; margin-top:12px">
      <button class="btn" id="closePodium">Close</button>
      <button class="btn gold" id="copyWinners">Copy winners</button>
    </div>
  </div>
</div>

<script>
(function(){
  // ---------- Config ----------
  const NUM_PLAYERS = 7;
  const INIT_NAMES  = ["Player 1","Player 2","Player 3","Player 4","Player 5","Player 6","Player 7"];
  const FIELD_TOP = 150, FIELD_BOTTOM_MARGIN = 40;
  const leftPad = 110, rightPad = 8, FINISH_GAP_FROM_FENCE = 8;
  const HORSE_EMOJI = 'üêé', EMOJI_SIZE = 44;
  const X_NEAR = 110, Y_SEP = 28, SPRING = 0.04, ITERATIONS = 2;

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAJTVGllUlmanFga4-eCuSi5YucB8F42TQ",
    authDomain: "horserace-50cd0.firebaseapp.com",
    databaseURL: "https://horserace-50cd0-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "horserace-50cd0",
    storageBucket: "horserace-50cd0.firebasestorage.app",
    messagingSenderId: "942770888682",
    appId: "1:942770888682:web:57b899f682ae6397325c93",
    measurementId: "G-EZDCQ7G8SV"
  };

  // ---------- State ----------
  const state = { totalRounds: 30, roundNow: 1, players: [], history: [], finishOrderIdxs: [], podiumShown:false, confettiStarted:false };

  // ---------- DOM ----------
  const elNameGrid = document.getElementById('nameGrid');
  const elRoundHud = document.getElementById('roundHud');
  const modeSelect = document.getElementById('modeSelect');
  const roomCodeEl = document.getElementById('roomCode');
  const createOrJoinRoom = document.getElementById('createOrJoinRoom');
  const openPlayerLink = document.getElementById('openPlayerLink');
  const autoStatus = document.getElementById('autoStatus');
  const questionPane = document.getElementById('questionPane');
  const qIndex = document.getElementById('qIndex');
  const qStem = document.getElementById('qStem');
  const optEls = [0,1,2,3].map(i=>document.getElementById('opt'+i));
  const voteClock = document.getElementById('voteClock');
  const forceLockBtn = document.getElementById('forceLock');
  const skipQBtn = document.getElementById('skipQ');

  // Canvas
  const canvas = document.getElementById('raceCanvas'), ctx = canvas.getContext('2d');
  let W=0,H=0,t=0,lastFrame=0;
  let baseScroll=140, scrollBoost=0, trackOffset=0;
  const finishLineX = ()=> W - rightPad, startLineX = ()=> leftPad;

  // Podium + confetti
  const overlay = document.getElementById('podiumOverlay');
  const podium1 = document.getElementById('podium1'), podium2 = document.getElementById('podium2'), podium3 = document.getElementById('podium3');
  const confetti = document.getElementById('confettiCanvas'), cctx = confetti.getContext('2d');
  let confettiRunning=false, confettiStart=0, confettiParts=[];
  const surged = new Set();

  // ---------- Utils ----------
  const clamp = (n,min,max)=> Math.min(max,Math.max(min,n));
  function mk(tag,cls,txt){ const el=document.createElement(tag); if(cls) el.className=cls; if(txt!=null) el.textContent=txt; return el; }
  const fmt = s => `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
  const normRoom = s => String(s||'').trim().toUpperCase();

  function isPlaceholderName(s){ return /^Player\s+\d+$/i.test(String(s||'').trim()); }
  function updateSeatUI(idx){
    const input = document.querySelectorAll('#nameGrid input')[idx];
    if (input) input.value = state.players[idx].name;
  }
  function ensureSeatForName(playerName){
    const name = String(playerName||'').trim();
    if (!name) return;
    const already = state.players.findIndex(p => p.name.trim() === name);
    if (already !== -1){ updateSeatUI(already); return; }
    const idx = state.players.findIndex(p => isPlaceholderName(p.name));
    if (idx === -1) return;
    state.players[idx].name = name; updateSeatUI(idx);
  }

  // ---------- Build host name list ----------
  function buildNameEditor(){
    elNameGrid.innerHTML='';
    state.players.forEach((p,i)=>{
      const nameInput = document.createElement('input');
      nameInput.type='text'; nameInput.value=p.name;
      nameInput.addEventListener('input', e=> p.name = e.target.value || `Player ${i+1}`);
      const posPill = document.createElement('div'); posPill.className='tiny'; posPill.id=`posPill${i}`; posPill.textContent='Moves: 0';
      const seat = document.createElement('div'); seat.className='tiny'; seat.textContent = `Seat #${i+1}`;
      elNameGrid.append(nameInput,posPill,seat);
    });
  }
  function updateSidebar(){ state.players.forEach((p,i)=>{ const el=document.getElementById(`posPill${i}`); if(el) el.textContent=`Moves: ${p.pos}`; }); }

  // ---------- Race engine ----------
  function approach(cur,tgt,dt,speed){ const d=tgt-cur; return cur+Math.sign(d)*Math.min(Math.abs(d),speed*dt); }
  function fieldGeometry(){ const top=FIELD_TOP, bot=H-FIELD_BOTTOM_MARGIN, height=Math.max(60,bot-top); return {top,bot,height}; }
  function layoutFieldY(){
    const { top, height } = fieldGeometry();
    for(let i=0;i<state.players.length;i++){
      const base = top + ((i + 0.5) / NUM_PLAYERS) * height;
      const spread = height / NUM_PLAYERS * 0.35;
      const jitter = (Math.random()*2 - 1) * spread;
      const baseY = clamp(base + jitter, top + 24, top + height - 24);
      const p = state.players[i]; p.baseY=baseY; if (p.y == null) p.y = baseY;
    }
  }
  function resolveCrowding(){
    const { top, bot } = fieldGeometry(); const minY = top + 24, maxY = bot - 24;
    state.players.forEach(p=>{ p.y += (p.baseY - p.y) * SPRING; });
    for(let it=0; it<ITERATIONS; it++){
      for(let i=0;i<state.players.length;i++){
        for(let j=i+1;j<state.players.length;j++){
          const a = state.players[i], b = state.players[j];
          const dx = Math.abs(a.animX - b.animX); if (dx > X_NEAR) continue;
          const dy = b.y - a.y, ady = Math.abs(dy);
          if (ady < Y_SEP){
            const overlap = (Y_SEP - ady) * (1 - dx / X_NEAR); const dir = dy >= 0 ? 1 : -1;
            a.y -= overlap * 0.5 * dir; b.y += overlap * 0.5 * dir;
          }
        }
      }
      state.players.forEach(p=>{ p.y = clamp(p.y, minY, maxY); });
    }
  }
  function drawBackground(off){
    const g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#0f1836'); g.addColorStop(1,'#0b1329'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
    const y=60; ctx.save(); ctx.globalAlpha=.35; ctx.fillStyle='#0b1e35'; for(let x=-W; x<W*2; x+=160){ ctx.fillRect(Math.floor(x-off*.18), y, 120, 30);} ctx.restore();
    const fy=120; ctx.strokeStyle='#ffffff'; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(0,fy); ctx.lineTo(W,fy); ctx.stroke();
    ctx.fillStyle='#e8e8e8'; for(let x=-W; x<W*2; x+=60){ const px=Math.floor(x-off*.45); ctx.fillRect(px,fy-14,4,14); }
    const { top, height } = fieldGeometry(); ctx.fillStyle='#2b7436'; ctx.fillRect(0, top, W, height);
    const stripeW = 120; for(let x=-W; x<W*2; x+=stripeW){ const sx=Math.floor(x-(off*0.35)%stripeW); ctx.fillStyle='rgba(255,255,255,0.04)'; ctx.fillRect(sx, top, stripeW/2, height); }
    const fx = finishLineX(); const finishTopY = fy + FINISH_GAP_FROM_FENCE;
    for (let i=0;i<12;i++){ ctx.fillStyle = i%2 ? '#fff' : '#cc2a2a'; ctx.fillRect(fx-3, finishTopY + i*6, 6,6); }
    for (let i=0;i<10;i++){ ctx.fillStyle = i%2 ? '#fff' : '#111'; ctx.fillRect(fx-28 + i*5, finishTopY - 16, 5,20); }
  }
  function drawHorses(){
    const { top } = fieldGeometry();
    const maxPos = Math.max(...state.players.map(p=>p.pos));
    const leaders = new Set(state.players.map((p,i)=> p.pos===maxPos ? i : null).filter(x=>x!==null));
    ctx.textAlign='center'; ctx.textBaseline='middle';
    state.players.forEach((p,i)=>{
      const cy = p.y ?? (top + 60 + i*40);
      const x  = p.animX ?? startLineX();

      // name plate behind horse ‚Äî gap=35
      const label = p.name; ctx.font='13px system-ui, sans-serif';
      const textW = Math.ceil(ctx.measureText(label).width);
      const padX=7, plateH=18, gap=35;
      const horseHalf = EMOJI_SIZE*0.6/2;
      const rightEdge = x - horseHalf - gap;
      const plateW = textW + padX*2;
      const plateX = Math.max(6, rightEdge - plateW);
      const plateY = cy - plateH/2 + 2;
      ctx.fillStyle='rgba(11,22,43,.85)'; ctx.strokeStyle='#22315c'; ctx.lineWidth=1.5;
      ctx.fillRect(plateX, plateY, plateW, plateH); ctx.strokeRect(plateX, plateY, plateW, plateH);
      ctx.beginPath(); ctx.moveTo(rightEdge, cy); ctx.lineTo(rightEdge-6, cy-5); ctx.lineTo(rightEdge-6, cy+5); ctx.closePath(); ctx.fill(); ctx.stroke();
      ctx.fillStyle='#cfe0ff'; ctx.textAlign='left'; ctx.textBaseline='middle'; ctx.fillText(label, plateX+padX, cy);

      if (leaders.has(i)){ ctx.save(); ctx.shadowColor='rgba(255,211,106,.7)'; ctx.shadowBlur=14; ctx.fillStyle='rgba(255,211,106,.18)'; ctx.beginPath(); ctx.arc(x,cy,24,0,Math.PI*2); ctx.fill(); ctx.restore(); }
      if (surged.has(i)){ ctx.save(); ctx.strokeStyle='#6ac2ff'; ctx.globalAlpha=.9; ctx.beginPath(); ctx.arc(x,cy,22,0,Math.PI*2); ctx.stroke(); ctx.restore(); }

      const bob=Math.sin((t*6)+(i*.7))*2.4, tilt=Math.sin((t*1.8)+(i*.9))*0.05;
      ctx.save(); ctx.translate(x, cy + bob); ctx.scale(-1,1); ctx.rotate(tilt);
      ctx.font = `${EMOJI_SIZE}px "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji",system-ui,sans-serif`;
      ctx.fillText(HORSE_EMOJI, 0, 0); ctx.restore();
    });
  }
  function loop(now){
    const dt = Math.max(0.001, Math.min(0.05,(now-lastFrame)/1000));
    lastFrame = now; t += dt;
    const scrollPx = (baseScroll + scrollBoost) * dt; trackOffset = (trackOffset + scrollPx) % 2000; scrollBoost = Math.max(0, scrollBoost - 380*dt);
    const startX=startLineX(), finishX=finishLineX(); const finishIdx = Math.max(1, state.totalRounds - 1);
    state.players.forEach((p,i)=>{ const percent = clamp(p.pos/finishIdx,0,1); const target = startX + percent*(finishX-startX); const speed = surged.has(i)? 520 : 320; p.animX = approach(p.animX, target, dt, speed); });
    resolveCrowding();
    ctx.clearRect(0,0,W,H); drawBackground(trackOffset); drawHorses();
    if (confettiRunning) drawConfetti();
    requestAnimationFrame(loop);
  }

  // Podium + confetti + scoring helpers
  function computeFinishOrderFromHistory(){
    const n = state.players.length; const pos = Array(n).fill(0), seen=new Set(), order=[];
    for (const deltas of state.history){
      for (const {idx, delta} of deltas){
        pos[idx] += delta;
        if (pos[idx] >= state.totalRounds && !seen.has(idx)){ seen.add(idx); order.push(idx); if (order.length>=3) return order; }
      }
    }
    return order;
  }
  function maybeShowPodium(){
    if (state.podiumShown) return;
    if (state.finishOrderIdxs.length >= 3){
      const [i1,i2,i3] = state.finishOrderIdxs;
      podium1.textContent = state.players[i1].name; podium2.textContent = state.players[i2].name; podium3.textContent = state.players[i3].name;
      overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false'); state.podiumShown = true;
    }
  }
  function hidePodium(){ overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true'); }
  function runConfetti(){
    confettiParts = []; const count = 220;
    for(let i=0;i<count;i++){ confettiParts.push({ x: Math.random()*confetti.width,y: -20 - Math.random()*confetti.height*0.4,vx: (Math.random()-0.5)*120,vy: 70 + Math.random()*140,size: 4 + Math.random()*6,rot: Math.random()*Math.PI*2,vr: (Math.random()-0.5)*6,shape: Math.random()<0.5?'rect':'circ',alpha: 0.8+Math.random()*0.2 }); }
    confetti.classList.add('show'); confettiRunning = true; confettiStart = performance.now(); state.confettiStarted = true;
  }
  function stopConfetti(){ confettiRunning=false; confetti.classList.remove('show'); }
  function drawConfetti(){
    const now = performance.now(); const elapsed = (now - confettiStart)/1000; if (elapsed > 8){ stopConfetti(); return; }
    cctx.clearRect(0,0,confetti.width, confetti.height);
    confettiParts.forEach(p=>{
      p.x += p.vx/60; p.y += p.vy/60; p.rot += p.vr/60;
      if (p.x < -20) p.x = confetti.width+20; if (p.x > confetti.width+20) p.x = -20; if (p.y > confetti.height+30) p.y = -20;
      cctx.save(); cctx.globalAlpha = p.alpha; cctx.translate(p.x, p.y); cctx.rotate(p.rot);
      const hue = (p.x/confetti.width*360 + elapsed*60) % 360; cctx.fillStyle = `hsl(${hue}, 90%, 60%)`;
      if (p.shape==='rect'){ cctx.fillRect(-p.size/2, -p.size/2, p.size, p.size*0.6); } else { cctx.beginPath(); cctx.arc(0,0,p.size/2,0,Math.PI*2); cctx.fill(); }
      cctx.restore();
    });
  }
  function applyDeltas(deltas){
    if (!Array.isArray(deltas) || deltas.length===0) return;
    state.history.push(deltas);
    deltas.forEach(({idx,delta})=> state.players[idx].pos += delta);
    if (state.roundNow < state.totalRounds) state.roundNow++;
    elRoundHud && (elRoundHud.textContent = `Round ${state.roundNow}/${state.totalRounds}`);
    updateSidebar();
    scrollBoost = 240; surged.clear(); deltas.forEach(d=>surged.add(d.idx)); setTimeout(()=>{ surged.clear(); }, 650);
    state.finishOrderIdxs = computeFinishOrderFromHistory();
    if (state.finishOrderIdxs.length >= 1 && !state.confettiStarted) runConfetti();
    maybeShowPodium();
  }

  // ---------- Firebase / Auto voting ----------
  let db=null;
  try{ firebase.initializeApp(firebaseConfig); db=firebase.database(); }catch(e){ if(firebase?.apps?.length){ db=firebase.database(); } }
  firebase.auth().signInAnonymously();

  async function getUid(){
    if (firebase.auth().currentUser) return firebase.auth().currentUser.uid;
    await new Promise(resolve=>{
      const unsub = firebase.auth().onAuthStateChanged(u=>{ if(u){ unsub(); resolve(); } });
    });
    return firebase.auth().currentUser.uid;
  }

  const engine = { mode:'auto', room:null, qid:0, questions:[], phase:'idle', voteOpenAt:0, endsAt:0, timer:null };

  function setMode(mode){
    engine.mode = mode;
    if (questionPane) questionPane.style.display = (mode==='auto') ? 'flex' : 'none';
    if (autoStatus) autoStatus.textContent = (mode==='auto') ? 'Auto mode' : 'Manual mode';
  }
  modeSelect?.addEventListener('change', ()=> setMode(modeSelect.value));

  async function loadQuestions(){
    try{
      const res = await fetch('questions.json', {cache:'no-store'});
      if (!res.ok) throw new Error('No questions.json found');
      engine.questions = await res.json();
    }catch(e){
      engine.questions = [{ stem:"Sample: 2+2=?", choices:["3","4","5","6"], correctIndex:1, timeLimitSec:15 }];
    }
  }

  openPlayerLink?.addEventListener('click', ()=>{
    const room = normRoom(roomCodeEl.value) || '2468';
    openPlayerLink.href = `player.html?room=${encodeURIComponent(room)}`;
  });

  createOrJoinRoom?.addEventListener('click', async ()=>{
    const room = normRoom(roomCodeEl.value); if(!room){ alert('Enter room code'); return; }
    engine.room = room; autoStatus && (autoStatus.textContent = 'Loading questions‚Ä¶');
    await loadQuestions();
    autoStatus && (autoStatus.textContent = `Room ${room} ready (${engine.questions.length} Qs)`);

    if (db){
      const ownerUid = await getUid();
      await db.ref(`/rooms/${room}/owners/${ownerUid}`).set(true);
      await db.ref(`/rooms/${room}/meta`).set({ qid: 0, phase: 'idle', totalRounds: engine.questions.length, voteOpenAt: null, endsAt: null });
      await db.ref(`/rooms/${room}/current`).remove();
      await db.ref(`/rooms/${room}/applied`).remove();

      const playersRef = db.ref(`/rooms/${room}/players`);
      playersRef.get().then(snap => { const obj = snap.val() || {}; Object.values(obj).forEach(p => ensureSeatForName(p?.name)); });
      playersRef.on('child_added', snap => { const p = snap.val() || {}; ensureSeatForName(p?.name); });
      playersRef.on('child_changed', snap => { const p = snap.val() || {}; ensureSeatForName(p?.name); });
    }

    setMode('auto');
    engine.qid = 0;
    startVote();
  });

  function startVote(){
    const q = engine.questions[engine.qid]; if(!q) return;
    engine.phase='vote_open';
    engine.voteOpenAt = Date.now();
    engine.endsAt = engine.voteOpenAt + (q.timeLimitSec||20)*1000;

    qIndex.textContent = 'Q ' + (engine.qid+1);
    qStem.textContent = q.stem || '‚Äî';
    (q.choices||[]).forEach((txt,i)=>{ if(optEls[i]) optEls[i].textContent = ['A','B','C','D'][i] + '. ' + (txt||''); });
    autoStatus && (autoStatus.textContent = `Voting‚Ä¶ (${q.timeLimitSec||20}s)`);

    tickVoteClock(); if(engine.timer) clearInterval(engine.timer);
    engine.timer = setInterval(tickVoteClock, 250);

    if (db && engine.room){
      db.ref(`/rooms/${engine.room}/meta`).update({ qid: engine.qid, phase:'vote_open', voteOpenAt: engine.voteOpenAt, endsAt: engine.endsAt });
      db.ref(`/rooms/${engine.room}/current`).set({ qid: engine.qid, stem: q.stem, choices: q.choices, timeLeft: Math.ceil((engine.endsAt - Date.now())/1000) });
      db.ref(`/rooms/${engine.room}/answers/${engine.qid}`).remove();
    }
  }
  function tickVoteClock(){
    const left = Math.max(0, Math.ceil((engine.endsAt - Date.now())/1000));
    voteClock.textContent = left+'s';
    if (db && engine.room) db.ref(`/rooms/${engine.room}/current/timeLeft`).set(left);
    if (left<=0){ clearInterval(engine.timer); engine.timer=null; enterVoteLock(); }
  }
  async function enterVoteLock(){
    engine.phase='vote_lock'; autoStatus && (autoStatus.textContent='Locking & scoring‚Ä¶');
    if (db && engine.room){ await db.ref(`/rooms/${engine.room}/meta/phase`).set('vote_lock'); }

    let votes = {};
    if (db && engine.room){ const snap = await db.ref(`/rooms/${engine.room}/answers/${engine.qid}`).get(); votes = snap.val() || {}; }
    const q = engine.questions[engine.qid]; const correctIndex = q.correctIndex;

    let uidName = {}, nameToIdx = new Map(state.players.map((p,i)=>[p.name.trim(), i]));
    if (db && engine.room){
      const ps = (await db.ref(`/rooms/${engine.room}/players`).get()).val() || {};
      for (const [u,info] of Object.entries(ps)){ uidName[u] = String(info?.name||'').trim(); }
    }

    const correctUIDs = Object.keys(votes).filter(u=> votes[u]?.choice===correctIndex && votes[u]?.serverTs < engine.endsAt);
    const deltas=[];

    if (correctUIDs.length){
      correctUIDs.forEach(u=>{ const idx = nameToIdx.get(uidName[u]||''); if (idx!=null) deltas.push({idx, delta:1}); });
      const ranked = correctUIDs.map(u=>({u, ts: votes[u].serverTs})).sort((a,b)=>a.ts-b.ts);
      const K = Math.max(1, Math.min(5, Math.round(0.15 * ranked.length)));
      const cutoffTs = ranked[Math.min(K-1, ranked.length-1)].ts;
      const fastestSet = new Set(ranked.filter(r=> r.ts <= cutoffTs).map(r=>r.u));
      ranked.forEach(({u})=>{
        if (fastestSet.has(u)){
          const idx = nameToIdx.get(uidName[u]||''); if (idx!=null){
            const d = deltas.find(x=>x.idx===idx); if (d) d.delta = Math.min(2, d.delta+1);
          }
        }
      });
    }

    engine.phase='reveal'; autoStatus && (autoStatus.textContent = `Reveal ‚Äî correct: ${['A','B','C','D'][correctIndex]}`);
    if (db && engine.room){ await db.ref(`/rooms/${engine.room}/meta/phase`).set('reveal'); }

    setTimeout(async ()=>{
      engine.phase='result'; if (db && engine.room){ await db.ref(`/rooms/${engine.room}/meta/phase`).set('result'); }
      let already=false;
      if (db && engine.room){
        const path = `/rooms/${engine.room}/applied/${engine.qid}`;
        const snap = await db.ref(path).get(); already = !!snap.val();
        if (!already){ applyDeltas(deltas); await db.ref(path).set(true); }
      } else { applyDeltas(deltas); }
      nextQuestion();
    }, 1000);
  }
  function nextQuestion(){
    engine.qid++;
    if (engine.qid >= engine.questions.length){
      autoStatus && (autoStatus.textContent = 'Done ‚Äî no more questions.');
      if (db && engine.room){ db.ref(`/rooms/${engine.room}/meta/phase`).set('idle'); }
      return;
    }
    if (db && engine.room){ db.ref(`/rooms/${engine.room}/meta/qid`).set(engine.qid); }
    startVote();
  }

  // ---------- Boot ----------
  function resize(){
    const r = canvas.getBoundingClientRect();
    canvas.width  = Math.floor(r.width  * devicePixelRatio);
    canvas.height = Math.floor(r.height * devicePixelRatio);
    ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    W=r.width; H=r.height;
    confetti.width  = Math.floor(r.width);
    confetti.height = Math.floor(r.height);
    layoutFieldY();
  }
  window.addEventListener('resize', resize);

  function drawConfetti(){ /* defined earlier */ } // (kept above)

  function init(){
    state.players = Array.from({length:NUM_PLAYERS},(_,i)=>({name:INIT_NAMES[i], pos:0, animX:startLineX(), y:null, baseY:null}));
    buildNameEditor();
    elRoundHud && (elRoundHud.textContent = `Round ${state.roundNow}/${state.totalRounds}`);
    resize(); lastFrame=performance.now(); requestAnimationFrame(loop);
  }
  init();

  document.getElementById('closePodium').onclick = ()=>hidePodium();
  document.getElementById('copyWinners').onclick = ()=>{
    navigator.clipboard?.writeText(`1st: ${podium1.textContent}, 2nd: ${podium2.textContent}, 3rd: ${podium3.textContent}`);
  };
})();
</script>
</body>
</html>
