<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Horse Race Quiz — PLAYER</title>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
  :root{ --bg:#0c1220; --card:#131a2e; --ink:#e9f0ff; --muted:#9aa4bf; --edge:#22315c; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--ink); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .bottom{max-width:780px; margin:16px auto; padding:0 12px 12px}
  .card{background:var(--card); border:1px solid var(--edge); border-radius:10px; padding:12px}
  .row{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
  label{font-size:13px;color:var(--muted)}
  input{background:#0f1527; color:var(--ink); border:1px solid var(--edge); border-radius:6px; padding:6px 8px; font-size:14px}
  .btn{cursor:pointer; border:1px solid var(--edge); background:#0f1527; color:var(--ink); padding:8px 10px; border-radius:8px; font-weight:600; font-size:14px}
  .pill{padding:4px 8px; border-radius:999px; background:#0f1527; border:1px solid var(--edge); color:#9aa4bf; font-size:12px}
</style>
</head>
<body>

<div class="bottom" id="playerView">
  <div class="card">
    <div class="row">
      <label>Room</label><input id="pvRoom" placeholder="2468" />
      <label>Name</label><input id="pvName" placeholder="Your name" />
      <button class="btn" id="pvJoin">Join</button>
      <span class="pill" id="pvStatus">Idle</span>
    </div>
  </div>

  <div class="card" id="pvQuestion" style="display:none; margin-top:10px">
    <div class="row">
      <strong id="pvQIndex">Q —</strong> <span id="pvStem">—</span>
      <span class="pill">Time left: <span id="pvClock">—</span></span>
    </div>
    <div class="row" style="gap:8px; margin-top:8px">
      <button class="btn" id="pvC0" data-i="0">A</button>
      <button class="btn" id="pvC1" data-i="1">B</button>
      <button class="btn" id="pvC2" data-i="2">C</button>
      <button class="btn" id="pvC3" data-i="3">D</button>
      <span class="pill" id="pvSubmitted">No answer yet</span>
    </div>
  </div>
</div>

<script>
(function(){
  // Firebase config (same as host)
  const firebaseConfig = {
    apiKey: "AIzaSyAJTVGllUlmanFga4-eCuSi5YucB8F42TQ",
    authDomain: "horserace-50cd0.firebaseapp.com",
    databaseURL: "https://horserace-50cd0-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "horserace-50cd0",
    storageBucket: "horserace-50cd0.firebasestorage.app",
    messagingSenderId: "942770888682",
    appId: "1:942770888682:web:57b899f682ae6397325c93",
    measurementId: "G-EZDCQ7G8SV"
  };

  // Init Firebase + anonymous auth
  let db=null;
  try{ firebase.initializeApp(firebaseConfig); db=firebase.database(); }catch(e){ if(firebase?.apps?.length){ db=firebase.database(); } }
  firebase.auth().signInAnonymously();

  // DOM
  const pv = {
    room: document.getElementById('pvRoom'),
    name: document.getElementById('pvName'),
    join: document.getElementById('pvJoin'),
    status: document.getElementById('pvStatus'),
    card: document.getElementById('pvQuestion'),
    qIndex: document.getElementById('pvQIndex'),
    stem: document.getElementById('pvStem'),
    clock: document.getElementById('pvClock'),
    submitted: document.getElementById('pvSubmitted'),
    choices: [0,1,2,3].map(i=>document.getElementById('pvC'+i))
  };

  const normRoom = s => String(s||'').trim().toUpperCase();

  async function getUid(){
    if (firebase.auth().currentUser) return firebase.auth().currentUser.uid;
    await new Promise(resolve=>{
      const unsub = firebase.auth().onAuthStateChanged(u=>{ if(u){ unsub(); resolve(); } });
    });
    return firebase.auth().currentUser.uid;
  }

  // Pre-fill from URL if present
  const qs = new URL(location.href).searchParams;
  if (qs.get('room')) pv.room.value = qs.get('room');
  if (qs.get('name')) pv.name.value = qs.get('name');

  let room=null, pname=null;

  pv.join.addEventListener('click', async ()=>{
    if (!db){ alert('Firebase not configured'); return; }
    room = normRoom(pv.room.value);
    pname = String(pv.name.value||'').trim() || 'Player';
    if(!room){ alert('Enter room'); return; }
    pv.status.textContent = 'Joining…';
    const uid = await getUid();
    await db.ref(`/rooms/${room}/players/${uid}`).set({ name: pname, active:true, joinedAt: firebase.database.ServerValue.TIMESTAMP });
    pv.status.textContent = 'Joined as '+pname;
    listenPlayerRoom();
  });

  function listenPlayerRoom(){
    db.ref(`/rooms/${room}/meta`).on('value', snap=>{
      const v = snap.val() || {};
      const show = (v.phase==='vote_open' || v.phase==='vote_lock' || v.phase==='reveal');
      pv.card.style.display = show ? 'block' : 'none';
    });
    db.ref(`/rooms/${room}/current`).on('value', snap=>{
      const v = snap.val() || {};
      if (v.qid==null){ pv.card.style.display='none'; return; }
      pv.qIndex.textContent = 'Q ' + (v.qid+1);
      pv.stem.textContent = v.stem || '—';
      pv.clock.textContent = v.timeLeft ?? '—';
      const ch = v.choices || [];
      pv.choices.forEach((btn,i)=> btn.textContent = ['A','B','C','D'][i] + (ch[i] ? ('. '+ch[i]) : ''));
    });
  }

  pv.choices.forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      if(!db){ return; }
      const meta = (await db.ref(`/rooms/${normRoom(pv.room.value)}/meta`).get()).val() || {};
      if (meta.phase !== 'vote_open'){ pv.submitted.textContent = 'Voting closed'; return; }
      const choice = Number(btn.dataset.i);
      const uid = await getUid();
      await db.ref(`/rooms/${normRoom(pv.room.value)}/answers/${meta.qid}/${uid}`).set({
        choice, serverTs: firebase.database.ServerValue.TIMESTAMP
      });
      pv.submitted.textContent = 'Submitted ' + ['A','B','C','D'][choice];
    });
  });
})();
</script>
</body>
</html>
